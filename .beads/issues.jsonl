{"id":"damus-7qv","title":"notedeck: Add ephemeral relay lease management","description":"No protection against concurrent lookups having their relay disconnected.\n\n## Leads\n\n- Add reference counting for ephemeral relay connections\n- Implement acquire/release lease pattern:\n  ```rust\n  fn acquire_lease(\u0026mut self, relay_url: \u0026str) -\u003e LeaseGuard\n  fn release_lease(\u0026mut self, relay_url: \u0026str)\n  ```\n- Only disconnect ephemeral relay when lease count reaches 0\n\n## Race condition to prevent\n\n```\nTask A: connect to relay.example.com (lease=1)\nTask B: connect to relay.example.com (lease=2)\nTask A: completes, disconnects relay (lease=1, but relay gone!)\nTask B: query fails - relay was disconnected\n```\n\n## iOS reference commits\n\n- 34781535: fix race condition in ephemeral relay lease release\n- ba879f09: Fix relay hint correctness issues","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-05T22:17:08.916663-06:00","created_by":"e","updated_at":"2026-01-05T22:17:08.916663-06:00","labels":["notedeck","relay-hints"]}
{"id":"damus-7rk","title":"notedeck: Fix atomicity in lease release","description":"Potential race if lease decrement happens after await.\n\n## Leads\n\n- Decrement lease count before any suspension point\n- After await, verify lease is still nil before removing relay\n- Prevents 1→2→1 cycle from incorrectly removing active relay\n\n## iOS reference commit\n\n- 34781535: fix: race condition in ephemeral relay lease release\n\nNote: This depends on damus-XXX (ephemeral relay lease management) being implemented first.","status":"open","priority":3,"issue_type":"bug","created_at":"2026-01-05T22:17:22.164019-06:00","created_by":"e","updated_at":"2026-01-05T22:17:22.164019-06:00","labels":["notedeck","relay-hints"],"dependencies":[{"issue_id":"damus-7rk","depends_on_id":"damus-7qv","type":"blocks","created_at":"2026-01-05T22:17:43.981189-06:00","created_by":"daemon"}]}
{"id":"damus-84c","title":"iOS: Add unit tests for relay hint logic","description":"No automated tests for relay hint logic.\n\n## Leads\n\n- Test TagSequence.relayHint extraction\n- Test MentionRef.from_tag with hints\n- Test first_eref_mention_with_hints() parsing\n- Test ephemeral relay lease acquire/release\n- Test grace period timing logic","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T22:17:29.519668-06:00","created_by":"e","updated_at":"2026-01-05T22:54:17.779915-06:00","closed_at":"2026-01-05T22:54:17.779915-06:00","close_reason":"Closed","labels":["ios","relay-hints","testing"]}
{"id":"damus-858","title":"notedeck: Add grace period for multi-relay hints","description":"When multiple relays are hinted, no wait for slower relays to connect.\n\n## Leads\n\n- When some hinted relays already connected, wait 200-300ms for others\n- Don't return immediately just because one relay is ready\n- Events may only exist on specific relay in the hint list\n\n## Implementation sketch\n\n```rust\nlet connected: Vec\u003c_\u003e = hints.iter().filter(|r| pool.is_connected(r)).collect();\nlet pending: Vec\u003c_\u003e = hints.iter().filter(|r| \\!pool.is_connected(r)).collect();\n\nif \\!connected.is_empty() \u0026\u0026 \\!pending.is_empty() {\n    // Wait grace period for pending relays\n    tokio::time::sleep(Duration::from_millis(300)).await;\n}\n```\n\n## iOS reference commits\n\n- d3cbb8d1: fix: enforce grace period when relays already connected\n- ba879f09: Fix relay hint correctness issues","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-05T22:17:11.695835-06:00","created_by":"e","updated_at":"2026-01-05T22:17:11.695835-06:00","labels":["notedeck","relay-hints"]}
{"id":"damus-cjj","title":"iOS: Add outgoing relay hints for replies, quotes, reposts","description":"iOS doesn't generate relay hints in outgoing events, breaking NIP-10/NIP-18 compliance.\n\n## Leads\n\n- **Replies:** Include relay hint in e-tag position 2\n  - Format: [\"e\", \u003cid\u003e, \u003crelay\u003e, \"reply\", \u003cpubkey\u003e]\n  - Files: PostView.swift, reply composition logic\n\n- **Quotes:** Include relay hint in q-tag\n  - Format: [\"q\", \u003cid\u003e, \u003crelay\u003e, \u003cpubkey\u003e]\n  - Files: Quote composition, NoteContentView\n\n- **Reposts:** Include relay hint in e-tag\n  - Format: [\"e\", \u003cid\u003e, \u003crelay\u003e]\n  - Use relay where original event was seen\n\n## Blocker\n\nNeed seen_relay or equivalent from nostrdb to know where events came from. May need nostrdb enhancement similar to nostrdb#113.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-05T22:16:13.785395-06:00","created_by":"e","updated_at":"2026-01-05T22:30:31.886358-06:00","closed_at":"2026-01-05T22:30:31.886358-06:00","close_reason":"Closed","labels":["ios","nip-10","relay-hints"],"comments":[{"id":1,"issue_id":"damus-cjj","author":"e","text":"## Resolution\n\nInvestigation revealed that **relay hints were already implemented** for:\n- ✅ Quotes (q-tags) - fully implemented with relay hint and pubkey\n- ✅ Reposts (e-tags) - already had relay hints and pubkey  \n- ✅ Reactions (e-tags) - already had relay hints and pubkey\n- ✅ Replies (e-tags) - had relay hints but **missing pubkey at position 4**\n\nThe relay hint source `pool.seen` dictionary + `relaysForEvent()` was already in use.\n\n## Changes Made\n\n1. **NoteRef struct** (Referenced.swift):\n   - Added `pubkey: Pubkey?` field\n   - Updated `from_tag()` to parse pubkey from tag position 4\n   - Updated `tag` computed property to include pubkey in output\n\n2. **nip10_reply_tags()** (PostView.swift):\n   - Now includes `replying_to.pubkey` in reply e-tag at position 4\n   - Root tag includes pubkey if available from parent's e-tag\n\n3. **NIP10Tests.swift**:\n   - Updated `test_marker_reply` expected output to include pubkey\n\nAll NIP-10 tests pass (11/11).","created_at":"2026-01-06T04:29:48Z"}]}
{"id":"damus-fw0","title":"notedeck: Pass relay hints through reaction chain","description":"When fetching a reaction's referenced note, hints may not be passed through.\n\n## Leads\n\n- Check if reaction handling passes hints to referenced note fetch\n- The referenced note is likely on the same relay as the reaction\n- Pass same hints when fetching the second hop\n\n## iOS reference commit\n\n- fcab121f: Pass relay hints to reaction referenced notes","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-05T22:17:14.554465-06:00","created_by":"e","updated_at":"2026-01-05T22:17:14.554465-06:00","labels":["notedeck","relay-hints"]}
{"id":"damus-uu4","title":"iOS: Add fallback broadcast retry for hint timeouts","description":"If hinted relay doesn't respond, iOS has no fallback mechanism.\n\n## Leads\n\n- Add timeout-based retry in EventLoaderView or SubscriptionManager\n- After 3-5s without response from hint relay, broadcast to all relays\n- Track pending hint-routed IDs for retry\n\n## Implementation sketch\n\n```swift\n// After hint lookup times out\nif !resolved \u0026\u0026 elapsed \u003e 3.0 {\n    // Re-queue without hints (broadcast)\n    fetchEvent(id: eventId, relayHints: [])\n}\n```\n\n## Reference\n\nnotedeck implements this with a 3s delayed broadcast retry.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-05T22:16:26.875074-06:00","created_by":"e","updated_at":"2026-01-05T22:46:43.687415-06:00","closed_at":"2026-01-05T22:46:43.687415-06:00","close_reason":"Closed","labels":["ios","relay-hints"]}
{"id":"damus-wfx","title":"iOS: Add integration tests for lookup fallback behavior","description":"The two-phase timeout behavior and broadcast fallback in SubscriptionManager.lookup(noteId:...) has no automated coverage.\n\n## Requirements\n\n- Test that hint phase respects timeout budget\n- Test that broadcast fallback is triggered when hints don't respond\n- Test that total timeout is honored (not exceeded)\n- Test that empty hint relay set skips directly to broadcast\n\n## Implementation approach\n\nOptions:\n1. Mock RelayPool with controllable subscribe behavior\n2. Use controllable clock (e.g., inject Clock protocol)\n3. Integration test with local relay and known behavior\n\n## Reference\n\ndamus/Core/Networking/NostrNetworkManager/SubscriptionManager.swift:363","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-05T23:14:13.287944-06:00","created_by":"e","updated_at":"2026-01-05T23:14:13.287944-06:00","labels":["ios","relay-hints","testing"]}
